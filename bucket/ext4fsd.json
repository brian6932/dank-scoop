{
    "version": "0.70b3",
    "homepage": "https://github.com/bobranten/Ext4Fsd",
    "description": "Ext4 file system driver for Windows",
    "license": "GPL-2.0-only",
    "url": "https://www.accum.se/~bosse/ext2fsd/0.70/Ext2Fsd-0.70b3w10-setup.exe#/_.zip",
    "hash": "a5ab9016999b1585f227b6dd354223700f254211a8f6be51abd7bac1b6f69aa2",
    "pre_install": [
        "if (!$global) { Write-Host -Foreground Red \"$app should be installed globally.\"; break }",
        "if ([string](bcdedit /enum '{current}') -cnotmatch '\\stestsigning\\s+Yes\\s') { Write-Host -Foreground Red \"$app requires testsigning.\"; break }",
        "if (!(Test-Path 'C:/Program Files (x86)/Windows Kits/*/bin/x86/Inf2Cat.exe')) { Write-Host -Foreground Red \"$app requires an installation of WDK (Windows Driver Kit).\"; break }",
        "if (!(Test-Path 'C:/Program Files (x86)/Microsoft Visual Studio/*/BuildTools/Common7/Tools/Microsoft.VisualStudio.DevShell.dll')) { \"$app requires VS Build Tools\"; break }",
        "'Documents', 'Ext2Fsd.pdb', 'Uninstall.exe' | ForEach-Object { Remove-Item -Recurse \"$dir/$_\" }"
    ],
    "installer": {
        "script": [
            "using namespace System.Security.Cryptography.X509Certificates",
            "Import-Module 'C:/Program Files (x86)/Microsoft Visual Studio/*/BuildTools/Common7/Tools/Microsoft.VisualStudio.DevShell.dll'",
            "Enter-VsDevShell 08d8510f -DevCmdArguments \"-arch=x$($architecture.Substring(0, 2)) -no_logo\"",
            "if (!(Test-Path \"$persist_dir/ext2fsd.cer\")) { MakeCert.exe -eku '1.3.6.1.5.5.7.3.3' -r -pe -ss TrustedPublisher -n CN=ext2fsd \"$dir\\ext2fsd.cer\" }",
            "& 'C:/Program Files (x86)/Windows Kits/*/bin/x86/Inf2Cat.exe' /driver:$dir /os:10_NI_X64,10_NI_ARM64,10_CO_X64,10_CO_ARM64,ServerFE_X64,ServerFE_ARM64,10_VB_X86,10_VB_X64,10_VB_ARM64,10_19H1_X86,10_19H1_X64,10_19H1_ARM64,10_RS5_X86,10_RS5_X64,10_RS5_ARM64,ServerRS5_X64,ServerRS5_ARM64,10_RS4_X86,10_RS4_X64,10_RS4_ARM64,10_RS3_X86,10_RS3_X64,10_RS3_ARM64,10_RS2_X86,10_RS2_X64,10_AU_X86,10_AU_X64",
            "signtool.exe sign /fd SHA256 /a /v /s TrustedPublisher /n ext2fsd /t http://timestamp.digicert.com \"$dir\\ext2fsd.cat\"",
            "$cert = (Get-AuthenticodeSignature \"$dir/ext2fsd.cat\").SignerCertificate",
            "$store = [X509Store]::new([StoreName]::TrustedPublisher, [StoreLocation]::LocalMachine)",
            "$store.Open([OpenFlags]::ReadWrite)",
            "$store.Add($cert.Export([X509ContentType]::Cert))",
            "$store.Close()",
            "Invoke-ExternalCommand pnputil -ArgumentList @('/add-driver', \"$dir\\ext2fsd.inf\", '/install') -RunAs -ContinueExitCodes @{ 3010 = 'A system reboot is required to finalize the installation.' } | Out-Null"
        ]
    },
    "persist": "ext2fsd.cer",
    "uninstaller": {
        "script": [
            "if ($cmd -ne 'uninstall') { return }",
            "pnputil.exe /delete-driver \"$dir\\ext2fsd.inf\" /uninstall | Out-Null",
            "sc.exe delete Ext2Fsd | Out-Null"
        ]
    },
    "bin": [
        "Ext2Mgr.exe",
        "Ext2Srv.exe"
    ],
    "shortcuts": [
        [
            "Ext2Mgr.exe",
            "Ext2 Manager"
        ]
    ],
    "checkver": {
        "url": "https://raw.githubusercontent.com/bobranten/Ext4Fsd/master/README.md",
        "regex": "https?://www\\.accum\\.se/~bosse/ext2fsd/(?<tag>[^/]+)/Ext2Fsd-(?<subver>([\\d.b]+)\\w*)-setup\\.exe"
    },
    "autoupdate": {
        "url": "https://www.accum.se/~bosse/ext2fsd/$matchTag/Ext2Fsd-$matchSubver-setup.exe#/_.zip"
    }
}
